name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      # ソースコードをチェックアウト
      - name: Checkout source code
        uses: actions/checkout@v3

      # GCP 認証 (Workload Identity Federation)
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ values.projectNumber }}/locations/global/workloadIdentityPools/poc-github-actions-pool/providers/poc-github-provider'
          service_account: 'rhdh-sa-gcp@${{ values.projectId }}.iam.gserviceaccount.com'

      # Artifact Registry 認証
      - name: Docker Auth
        run: gcloud auth configure-docker asia-northeast1-docker.pkg.dev

      # ビルド & プッシュ (GCP Artifact Registry)
      - name: Build and Push Docker image
        run: |
          # レジストリURLの定義
          REGISTRY="asia-northeast1-docker.pkg.dev/${{ values.projectId }}/poc-rhdh-repository"
          IMAGE_TAG="${{ values.app_name }}:${{ "${{" }} github.sha }}"
          
          docker build -t $REGISTRY/$IMAGE_TAG .
          docker push $REGISTRY/$IMAGE_TAG

  update_manifests:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    needs: [build_and_push]
    steps:
      - name: Create token for manifest repository
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ "${{" }} secrets.GITHUBAPP_ID }}
          private-key: ${{ "${{" }} secrets.GITHUBAPP_PRIVATE_KEY }}
          owner: ${{ values.git_owner_name }}
          repositories: ${{ values.git_repo_name }}-manifest

      - name: Checkout manifest repository
        uses: actions/checkout@v4
        with:
          repository: ${{ values.git_owner_name }}/${{ values.git_repo_name }}-manifest
          path: ${{ values.git_repo_name }}-manifest
          token: ${{ "${{" }} steps.app-token.outputs.token }}  
  
      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin

      - name: Update Manifests
        run: |
          TARGET_DIR="${{ values.git_repo_name }}-manifest/kustomize"
          IMAGE_URL="asia-northeast1-docker.pkg.dev/${{ values.projectId }}/poc-rhdh-repository/${{ values.app_name }}:${{ github.sha }}"
          find $TARGET_DIR -name "*.yaml" -type f -exec sed -i "s|___IMAGE_URL___|$IMAGE_URL|g" {} +
          find $TARGET_DIR -name "*.yaml" -type f -exec sed -i "s|@___IMAGE_DIGEST___||g" {} +
          echo "Updated all manifest files in $TARGET_DIR with: $IMAGE_URL"

      - name: Commit and push changes
        run: |
          cd ${{ values.git_repo_name }}-manifest

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git diff-index --quiet HEAD || git commit -m "Update kustomize manifests for commit ${{ github.sha }}"

          git push origin HEAD:develop
  
  deploy_application:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    needs: [update_manifests]
    steps:
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/argocd
      
      - name: Sync and wait for deployment
        run: |
          argocd login "${{ "${{" }} vars.ARGOCD_INSTANCE_URL }}" --username "${{ "${{" }} secrets.ARGOCD_USERNAME }}" --password "${{ "${{" }} secrets.ARGOCD_PASSWORD }}" --skip-test-tls --grpc-web
          echo "Waiting for ArgoCD to be ready..."
          sleep 15
          argocd app sync ${{ values.app_name }} --revision develop
          argocd app wait ${{ values.app_name }} --health

